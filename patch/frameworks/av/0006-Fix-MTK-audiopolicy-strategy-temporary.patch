From 5b38c6b8b5379e71437912fceebf792d9aab7983 Mon Sep 17 00:00:00 2001
From: root <root@localhost.local>
Date: Wed, 8 Feb 2023 05:49:23 +0300
Subject: [PATCH] Fix MTK audiopolicy strategy(temporary)

Change-Id: Id509b8e16eb16b30046b10f7033c54fe17ab4bbc
---
 .../audiopolicy/enginedefault/src/Engine.cpp  | 29 +++++++++++++++++++
 1 file changed, 29 insertions(+)

diff --git a/services/audiopolicy/enginedefault/src/Engine.cpp b/services/audiopolicy/enginedefault/src/Engine.cpp
index a786f2d..effe31b 100755
--- a/services/audiopolicy/enginedefault/src/Engine.cpp
+++ b/services/audiopolicy/enginedefault/src/Engine.cpp
@@ -32,6 +32,7 @@
 #include <policy.h>
 #include <utils/String8.h>
 #include <utils/Log.h>
+#include <cutils/properties.h>
 
 namespace android
 {
@@ -620,6 +621,34 @@ audio_devices_t Engine::getDeviceForStrategy(routing_strategy strategy) const
         break;
     }
 
+#ifdef MTK_HARDWARE
+    if ((device & (AUDIO_DEVICE_OUT_BLUETOOTH_A2DP |
+                  AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES |
+                  AUDIO_DEVICE_OUT_WIRED_HEADSET |
+                  AUDIO_DEVICE_OUT_WIRED_HEADPHONE))
+
+        && (device & AUDIO_DEVICE_OUT_SPEAKER)
+
+        && (strategy == STRATEGY_SONIFICATION ||
+            strategy == STRATEGY_SONIFICATION_RESPECTFUL ||
+            strategy == STRATEGY_ENFORCED_AUDIBLE)) {
+
+        audio_devices_t old_device = device;
+
+        //ALOGE("isInCall() - %d\n", isInCall());
+
+        if (!outputs.isStreamActive(AUDIO_STREAM_ALARM)
+            && !property_get_bool("persist.out_all_ring", true)) {
+            device &= ~(AUDIO_DEVICE_OUT_SPEAKER);
+        }
+
+        ALOGVV("getDeviceForStrategy() reset unsupported bit, "
+              "before = %#x, after = %#x, strategy = %#x",
+               old_device, device, strategy);
+
+    }
+#endif
+
     ALOGVV("getDeviceForStrategy() strategy %d, device %x", strategy, device);
     return device;
 }
-- 
2.30.2

